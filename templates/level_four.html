{% extends '_base.html' %}
{% load static %}
{% block content %}
<div class="level_one_background">
    <div class="container text-center mt-5 fs-4">
    <h3 class="fw-bold py-3 px-5 rounded-pill shadow-lg text-white fs-1"
        style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.4); box-shadow: 0 0 25px rgba(255, 105, 255, 0.7);">
      Picture Word Puzzle
    </h3>

    <!-- Level -->
    <h5 class="fw-bold py-2 px-4 mt-4 rounded-pill text-dark fs-3"
        style="background: rgba(255, 193, 7, 0.4); backdrop-filter: blur(8px); box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);">
      LEVEL FOUR
    </h5>

    <!-- Instructions -->
    <p class="fw-semibold mt-4 py-2 px-4 rounded-3 d-inline-block fs-5"
       style="color: #212529; background: rgba(40, 167, 69, 0.3); backdrop-filter: blur(6px); border: 1px solid rgba(40, 167, 69, 0.4); box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);">
      Scramble the letters until you get the names of those images.
    </p>

    <div class="row justify-content-center mt-4">
        <!-- Left side: images -->
        <div class="col-md-4 d-flex flex-column align-items-end">
        <!-- replace with {% static '...' %} -->
        <img src="{% static 'images/tiger.png' %}" alt="tiger" width="90" class="mb-4">
        <img src="{% static 'images/zibra.png' %}" alt="Zebra" width="100">
        </div>

        <!-- Right side: puzzle grid -->
        <div class="col-md-4 d-flex flex-column align-items-start">
        <table id="grid" class="table table-borderless text-center align-middle">
            <tbody>
            <tr>
                <td>t</td><td>x</td><td>k</td><td>l</td><td>q</td>
                <td>
                <button class="btn btn-sm btn-primary move-row" data-row="0">â†’</button>
                </td>
            </tr>
            <tr>
                <td class="table-warning">a</td><td class="table-warning">i</td><td class="table-warning">g</td><td class="table-warning">e</td><td class="table-warning">r</td>
                <td>
                <button class="btn btn-sm btn-primary move-row" data-row="1">â†’</button>
                </td>
            </tr>
            <tr>
                <td>z</td><td>p</td><td>n</td><td>w</td><td>s</td>
                <td>
                <button class="btn btn-sm btn-primary move-row" data-row="2">â†’</button>
                </td>
            </tr>
            <tr>
                <td class="table-warning">m</td><td class="table-warning">e</td><td class="table-warning">b</td><td class="table-warning">r</td><td class="table-warning">a</td>
                <td>
                <button class="btn btn-sm btn-primary move-row" data-row="3">â†’</button>
                </td>
            </tr>
            <tr>
                <td>v</td><td>a</td><td>z</td><td>p</td><td>s</td>
                <td>
                <button class="btn btn-sm btn-primary move-row" data-row="4">â†’</button>
                </td>
            </tr>
            </tbody>
        </table>


        <!-- column buttons -->
        <div class="d-flex w-100 px-2 ms-2" style="gap: 31px;">
            <button class="btn btn-success btn-md move-col" data-col="0">â†“</button>
            <button class="btn btn-success btn-md move-col" data-col="1">â†“</button>
            <button class="btn btn-success btn-md move-col" data-col="2">â†“</button>
            <button class="btn btn-success btn-md move-col" data-col="3">â†“</button>
            <button class="btn btn-success btn-md move-col" data-col="4">â†“</button>
        </div>
        </div>
    </div>
     <div class="mt-4">
      {% if level > 4 %}
        <div class="alert alert-info shadow-lg border-0 rounded-pill d-inline-block px-4 py-2"
             style="background: rgba(23, 162, 184, 0.3); backdrop-filter: blur(6px); color: white; font-weight: 600;">
          ðŸŽ‰ You already won this level!
        </div>
      {% endif %}
    </div>
    </div>
    
</div>

<!-- win alert container -->
<div id="win-alert-container" class="position-fixed top-50 start-50 translate-middle" 
     style="z-index: 1050; display: none;">
  <div class="alert alert-success alert-dismissible fade show text-center p-4" role="alert" 
       style="background-color: #d4edda; border: none; border-radius: 15px;">
    <img src="{% static 'images/win_gif4.gif' %}" alt="You Win!" class="img-fluid" style="max-width: 400px;">
  </div>
</div>
{{ level|json_script:"level-data" }}

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("grid");
  const rows = Array.from(grid.querySelectorAll("tr")).map(row =>
    Array.from(row.querySelectorAll("td"))
      .slice(0, 5) // take only the first 5 <td> (letters)
      .map(td => td.textContent)
  );

  // shift one row right
  function shiftRight(arr) {
    const last = arr.pop();
    arr.unshift(last);
    return arr;
  }

  // shift one column down
  function shiftColumnDown(matrix, colIndex) {
    const last = matrix[matrix.length - 1][colIndex];
    for (let i = matrix.length - 1; i > 0; i--) {
      matrix[i][colIndex] = matrix[i - 1][colIndex];
    }
    matrix[0][colIndex] = last;
    return matrix;
  }

  // update DOM after change
  function updateGrid() {
    grid.querySelectorAll("tr").forEach((row, rIdx) => {
      row.querySelectorAll("td").forEach((cell, cIdx) => {
        if (cIdx < 5) cell.textContent = rows[rIdx][cIdx];
      });
    });

   const level = JSON.parse(document.getElementById('level-data').textContent);

   console.log("Current level:", level); // e.g., 3

   if (!Number.isNaN(level) && level <= 4) {
      // Example: run game function
      checkWin();
    } else {
      console.log("You need to unlock Level 1 first!");
    }
  }

  // âœ… Check if user solved the puzzle
 function checkWin() {
  const firstRow = rows[1].join("").toLowerCase(); // first colored row
  const secondRow = rows[3].join("").toLowerCase(); // second colored row

  if (firstRow === "tiger" && secondRow === "zebra") {
    // Play winning sound
    const audio = new Audio("{% static 'sounds/win.mp3' %}");
    audio.play();

    // Show Bootstrap alert
    const alertContainer = document.getElementById("win-alert-container");
    alertContainer.style.display = "block";

    // Send +1 update to Django via fetch
    fetch("{% url 'increment_level' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        console.log("âœ… Level increased to:", data.new_level);
      } else {
        console.error("âš ï¸ Failed to update level.");
      }
    })
    .catch(err => console.error("âŒ Error:", err));


    // Automatically hide after 3 seconds
    setTimeout(() => {
      alertContainer.style.display = "none";

      // Redirect to next level after alert disappears
      window.location.href = "{% url 'level_five' %}";
    }, 3000); // 3 seconds
  }
}


  // row buttons (blue)
  document.querySelectorAll(".move-row").forEach(btn => {
    btn.addEventListener("click", () => {
      const r = parseInt(btn.dataset.row);
      rows[r] = shiftRight(rows[r]);
      updateGrid();
    });
  });

  // column buttons (green)
  document.querySelectorAll(".move-col").forEach(btn => {
    btn.addEventListener("click", () => {
      const c = parseInt(btn.dataset.col);
      shiftColumnDown(rows, c);
      updateGrid();
    });
  });
});
</script>

{% endblock content %}
